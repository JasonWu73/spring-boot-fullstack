import{c as Pe,j as e,B as I,R as te,h as M,Q as se,T as ae,V as ne,a as Q,b as re,E as Ae,r as G,P as Ie,$ as oe,k as d,I as ce,D as ie,l as F,_ as T,G as X,H as Te,W as le,X as de,i as U,Y as Me,Z,a0 as Ue,a1 as Oe,a2 as Fe,a3 as Le,a4 as q,L as ue,a5 as He,q as qe,v as Be,a6 as B,a7 as K,a8 as z,a9 as Y}from"./index-f29c37fe.js";import{u as he,F as fe,e as O,f as J,D as Ke,g as ze,h as Ye,i as We,j as Qe,k as Ge,l as Xe,m as be,B as W,C as Ze,a as Ve,b as Je,c as et,d as tt}from"./CustomFormField-a6762e0b.js";import{C as N}from"./Code-8e922a91.js";import{D as R,a as st,b as at,c as nt}from"./DataTableColumnHeader-5ff0f1d0.js";import{a as rt}from"./use-refresh-e248a172.js";import{u as ot}from"./use-title-bfe6ef72.js";import{z as _,t as me}from"./index-a1d6eb7d.js";import{C as ct}from"./ConfirmDialog-b4714992.js";import{A as it,a as lt,b as dt}from"./Alert-fc7e4ad1.js";import{e as ut}from"./rsa-fd848fa5.js";import"./Skeleton-15b235d6.js";/**
 * @license lucide-react v0.293.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=Pe("MoreHorizontal",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]),ft=[{value:"",label:"全部"},{value:"0",label:"禁用"},{value:"1",label:"启用"}],bt=[{value:"",label:"全部"},se,ae,ne],mt=_.object({username:_.string().trim(),nickname:_.string().trim(),status:_.string().trim(),authority:_.string().trim()}),ee={username:"",nickname:"",status:"",authority:""};function pt({queryParams:t,loading:a,onSearch:n}){var s,o,i,x;const c=he({resolver:me(mt),defaultValues:ee});xt(t,c.setValue);function r(g){n(g)}function u(){c.reset(),r(ee)}return e.jsx(fe,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(r),className:"mb-8 flex flex-wrap items-center gap-4",children:[e.jsx(O,{control:c.control,name:"username",type:"text",label:"用户名",labelWidth:45,placeholder:"用户名",isError:(s=c.getFieldState("username"))==null?void 0:s.invalid}),e.jsx(O,{control:c.control,name:"nickname",type:"text",label:"昵称",labelWidth:45,placeholder:"昵称",isError:(o=c.getFieldState("nickname"))==null?void 0:o.invalid}),e.jsx(J,{control:c.control,name:"status",label:"状态",labelWidth:45,options:ft,isError:(i=c.getFieldState("status"))==null?void 0:i.invalid}),e.jsx(J,{control:c.control,name:"authority",label:"权限",labelWidth:45,options:bt,isError:(x=c.getFieldState("authority"))==null?void 0:x.invalid}),e.jsxs(I,{type:"submit",className:"self-end",disabled:a,children:[a&&e.jsx(te,{className:"mr-2 h-4 w-4 animate-spin"}),"查询"]}),e.jsx(I,{onClick:u,type:"reset",variant:"outline",className:"self-end",disabled:a,children:"重置"})]})})}function xt(t,a){M.useEffect(()=>{a("username",t.username),a("nickname",t.nickname),a("status",t.status),a("authority",t.authority)},[t,a])}const kt=_.object({password:_.string().min(1,"必须输入密码"),confirmPassword:_.string().min(1,"必须输入确认密码")}).refine(({password:t,confirmPassword:a})=>t===a,{message:"密码和确认密码必须相同",path:["confirmPassword"]}),$t={password:"",confirmPassword:""};function jt({open:t,onOpenChange:a,user:n,updateState:c}){var $,w;const r=he({resolver:me(kt),defaultValues:$t}),{error:u,loading:s,requestData:o,updateState:i}=Q(G),{toast:x}=re();async function g(h,b){return await o({url:`/api/v1/users/${h}/password`,method:"PUT",bodyData:{password:ut(Ie,b)}})}async function f(h){const{status:b}=await g(n.id,h.password);b===204&&(c(k=>{if(!k.data)return k;const p=k.data.list.map(C=>C.id===n.id?{...C,updatedAt:be(new Date,"yyyy-MM-dd HH:mm:ss")}:C);return{...k,data:{...k.data,list:p}}}),m(),a(!1),x({title:"重置用户密码成功",description:e.jsxs("span",{children:["成功重置用户 ",e.jsx(N,{children:n.username})," 登录密码"]})}))}function m(){r.reset(),i(h=>({...h,error:void 0}))}function v(h){h||m(),a(h)}return e.jsx(Ke,{open:t,onOpenChange:v,children:e.jsxs(ze,{className:"max-w-md",children:[e.jsxs(Ye,{children:[e.jsxs(We,{children:["重置用户 ",e.jsx(N,{children:n.username})," 密码"]}),e.jsx(Qe,{children:"重置后，用户将使用新密码登录系统"})]}),e.jsx(fe,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(f),autoComplete:"off",className:"flex flex-col gap-4",children:[!s&&u&&e.jsxs(it,{variant:"destructive",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx(lt,{children:"重置用户密码失败"}),e.jsx(dt,{children:u})]}),e.jsx(O,{control:r.control,name:"password",type:"password",label:"密码",labelWidth:60,placeholder:"密码",isError:($=r.getFieldState("password"))==null?void 0:$.invalid}),e.jsx(O,{control:r.control,name:"confirmPassword",type:"password",label:"确认密码",labelWidth:60,placeholder:"确认密码",isError:(w=r.getFieldState("confirmPassword"))==null?void 0:w.invalid}),e.jsxs(Ge,{children:[e.jsx(Xe,{asChild:!0,children:e.jsx(I,{type:"button",variant:"outline",disabled:s,children:"取消"})}),e.jsxs(I,{type:"submit",disabled:s,children:[s&&e.jsx(te,{className:"mr-2 h-4 w-4 animate-spin"}),"提交"]})]})]})})]})})}const pe="Checkbox",[gt,Xt]=oe(pe),[wt,Ct]=gt(pe),yt=d.forwardRef((t,a)=>{const{__scopeCheckbox:n,name:c,checked:r,defaultChecked:u,required:s,disabled:o,value:i="on",onCheckedChange:x,...g}=t,[f,m]=d.useState(null),v=ce(a,p=>m(p)),$=d.useRef(!1),w=f?!!f.closest("form"):!0,[h=!1,b]=ie({prop:r,defaultProp:u,onChange:x}),k=d.useRef(h);return d.useEffect(()=>{const p=f==null?void 0:f.form;if(p){const C=()=>b(k.current);return p.addEventListener("reset",C),()=>p.removeEventListener("reset",C)}},[f,b]),d.createElement(wt,{scope:n,state:h,disabled:o},d.createElement(F.button,T({type:"button",role:"checkbox","aria-checked":P(h)?"mixed":h,"aria-required":s,"data-state":xe(h),"data-disabled":o?"":void 0,disabled:o,value:i},g,{ref:v,onKeyDown:X(t.onKeyDown,p=>{p.key==="Enter"&&p.preventDefault()}),onClick:X(t.onClick,p=>{b(C=>P(C)?!0:!C),w&&($.current=p.isPropagationStopped(),$.current||p.stopPropagation())})})),w&&d.createElement(Et,{control:f,bubbles:!$.current,name:c,value:i,checked:h,required:s,disabled:o,style:{transform:"translateX(-100%)"}}))}),St="CheckboxIndicator",vt=d.forwardRef((t,a)=>{const{__scopeCheckbox:n,forceMount:c,...r}=t,u=Ct(St,n);return d.createElement(Te,{present:c||P(u.state)||u.state===!0},d.createElement(F.span,T({"data-state":xe(u.state),"data-disabled":u.disabled?"":void 0},r,{ref:a,style:{pointerEvents:"none",...t.style}})))}),Et=t=>{const{control:a,checked:n,bubbles:c=!0,...r}=t,u=d.useRef(null),s=le(n),o=de(a);return d.useEffect(()=>{const i=u.current,x=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(x,"checked").set;if(s!==n&&f){const m=new Event("click",{bubbles:c});i.indeterminate=P(n),f.call(i,P(n)?!1:n),i.dispatchEvent(m)}},[s,n,c]),d.createElement("input",T({type:"checkbox","aria-hidden":!0,defaultChecked:P(n)?!1:n},r,{tabIndex:-1,ref:u,style:{...t.style,...o,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function P(t){return t==="indeterminate"}function xe(t){return P(t)?"indeterminate":t?"checked":"unchecked"}const ke=yt,Dt=vt,V=d.forwardRef(({className:t,...a},n)=>e.jsx(ke,{ref:n,className:U("peer h-4 w-4 shrink-0 rounded-sm border border-slate-800 shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-sky-500 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:border-sky-500 data-[state=checked]:bg-sky-500 data-[state=checked]:text-slate-50 dark:border-slate-100  dark:focus-visible:ring-slate-700 dark:data-[state=checked]:bg-slate-50 dark:data-[state=checked]:text-sky-900",t),...a,children:e.jsx(Dt,{className:U("flex items-center justify-center text-current"),children:e.jsx(Me,{className:"h-4 w-4"})})}));V.displayName=ke.displayName;const $e="Switch",[Rt,Zt]=oe($e),[_t,Nt]=Rt($e),Pt=d.forwardRef((t,a)=>{const{__scopeSwitch:n,name:c,checked:r,defaultChecked:u,required:s,disabled:o,value:i="on",onCheckedChange:x,...g}=t,[f,m]=d.useState(null),v=ce(a,k=>m(k)),$=d.useRef(!1),w=f?!!f.closest("form"):!0,[h=!1,b]=ie({prop:r,defaultProp:u,onChange:x});return d.createElement(_t,{scope:n,checked:h,disabled:o},d.createElement(F.button,T({type:"button",role:"switch","aria-checked":h,"aria-required":s,"data-state":je(h),"data-disabled":o?"":void 0,disabled:o,value:i},g,{ref:v,onClick:X(t.onClick,k=>{b(p=>!p),w&&($.current=k.isPropagationStopped(),$.current||k.stopPropagation())})})),w&&d.createElement(Tt,{control:f,bubbles:!$.current,name:c,value:i,checked:h,required:s,disabled:o,style:{transform:"translateX(-100%)"}}))}),At="SwitchThumb",It=d.forwardRef((t,a)=>{const{__scopeSwitch:n,...c}=t,r=Nt(At,n);return d.createElement(F.span,T({"data-state":je(r.checked),"data-disabled":r.disabled?"":void 0},c,{ref:a}))}),Tt=t=>{const{control:a,checked:n,bubbles:c=!0,...r}=t,u=d.useRef(null),s=le(n),o=de(a);return d.useEffect(()=>{const i=u.current,x=window.HTMLInputElement.prototype,f=Object.getOwnPropertyDescriptor(x,"checked").set;if(s!==n&&f){const m=new Event("click",{bubbles:c});f.call(i,n),i.dispatchEvent(m)}},[s,n,c]),d.createElement("input",T({type:"checkbox","aria-hidden":!0,defaultChecked:n},r,{tabIndex:-1,ref:u,style:{...t.style,...o,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function je(t){return t?"checked":"unchecked"}const ge=Pt,Mt=It,we=d.forwardRef(({className:t,...a},n)=>e.jsx(ge,{className:U("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 focus-visible:ring-offset-white disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-green-500 data-[state=unchecked]:bg-slate-200 dark:focus-visible:ring-slate-300 dark:focus-visible:ring-offset-slate-950 dark:data-[state=checked]:bg-green-600 dark:data-[state=unchecked]:bg-slate-800",t),...a,ref:n,children:e.jsx(Mt,{className:U("pointer-events-none block h-4 w-4 rounded-full bg-white shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0 dark:bg-slate-950")})}));we.displayName=ge.displayName;function Ut({submitting:t,currentUserRef:a,onChangeStatus:n,setOpenDeleteDialog:c,setOpenResetPasswordDialog:r}){const u=[{id:"选择",header:({table:s})=>e.jsx(V,{checked:s.getIsAllPageRowsSelected(),onCheckedChange:o=>s.toggleAllPageRowsSelected(!!o),"aria-label":"全选"}),cell:({row:s})=>e.jsx(V,{checked:s.getIsSelected(),onCheckedChange:o=>s.toggleSelected(!!o),"aria-label":"选择行"}),enableSorting:!1,enableHiding:!1},{id:"ID",accessorKey:"id",header:({column:s})=>e.jsx(R,{column:s,title:"ID"})},{id:"昵称",header:({column:s})=>e.jsx(R,{column:s,title:"昵称"}),cell:({row:s})=>s.original.nickname},{id:"用户名",accessorKey:"username",header:({column:s})=>e.jsxs(R,{column:s,children:["用户名",e.jsx("span",{className:"ml-1 text-xs text-slate-500",children:"（可用作登录）"})]}),cell:({row:s})=>e.jsx(N,{children:s.original.username})},{id:"账号状态",header:({column:s})=>e.jsxs(R,{column:s,children:["账号状态",e.jsx("span",{className:"ml-1 text-xs text-slate-500",children:"（禁用后不可登录）"})]}),cell:({row:s})=>{const o=s.original,i=o.status===1;return e.jsx(we,{checked:i,disabled:t,onCheckedChange:()=>n(o,i)})}},{id:"权限",header:({column:s})=>e.jsx(R,{column:s,title:"权限"}),cell:({row:s})=>{const o=s.original;return e.jsx("div",{className:"space-x-1",children:o.authorities.map(i=>i===se.value?e.jsx(W,{variant:"destructive",children:"超级管理员"},i):i===ae.value?e.jsx(W,{children:"管理员"},i):i===ne.value?e.jsx(W,{variant:"outline",children:"用户"},i):null)})}},{id:"创建时间",accessorKey:"createdAt",header:({column:s})=>e.jsx(R,{sortable:!0,column:s,title:"创建时间"})},{id:"更新时间",accessorKey:"updatedAt",header:({column:s})=>e.jsx(R,{sortable:!0,column:s,title:"更新时间"})},{id:"备注",accessorKey:"remark",header:({column:s})=>e.jsx(R,{column:s,title:"备注"})},{id:"操作",header:({column:s})=>e.jsx(R,{column:s,title:"操作"}),cell:({row:s})=>{const o=s.original;return e.jsxs(Ue,{children:[e.jsx(Oe,{asChild:!0,disabled:t,children:e.jsx(I,{variant:"ghost",className:"h-8 w-8 p-0",children:e.jsx(ht,{className:"h-4 w-4"})})}),e.jsxs(Fe,{align:"end",children:[e.jsx(Le,{children:"操作"}),e.jsx(q,{className:"p-0",asChild:!0,children:e.jsx(ue,{to:`/users/${o.id}`,className:"inline-block w-full px-2 py-1.5",children:"查看详情"})}),Z&&e.jsxs(e.Fragment,{children:[e.jsx(He,{}),e.jsx(q,{className:"p-0",asChild:!0,children:e.jsx("button",{onClick:()=>{c(!0),a.current=o},className:"inline-block w-full px-2 py-1.5 text-left text-red-500 dark:text-red-600",children:"删除用户"})}),e.jsx(q,{className:"p-0",asChild:!0,children:e.jsx("button",{onClick:()=>{r(!0),a.current=o},className:"inline-block w-full px-2 py-1.5 text-left text-red-500 dark:text-red-600",children:"重置密码"})})]})]})]})}}];return Z?u:u.filter(s=>s.id!=="选择")}function Ot({data:t,error:a,loading:n,submitting:c,pagination:r,onPaginate:u,sortColumn:s,onSorting:o,onSelect:i,onShowSelection:x,onChangeStatus:g,onDeleteUser:f,updatePaging:m}){const[v,$]=M.useState(!1),[w,h]=M.useState(!1),b=M.useRef(null);function k(){b.current&&f(b.current)}return e.jsxs(e.Fragment,{children:[e.jsx(st,{columns:Ut({submitting:c,currentUserRef:b,onChangeStatus:g,setOpenDeleteDialog:$,setOpenResetPasswordDialog:h}),data:t,error:a,loading:n,pagination:r,onPaginate:u,sortColumn:s,onSorting:o,enableRowSelection:!0,onSelect:i,children:Z&&e.jsxs("div",{children:[e.jsx(I,{onClick:x,size:"sm",variant:"secondary",children:"查看被选中的行"}),e.jsx(ue,{to:"/users/add",className:U("ml-2",qe({variant:"default",size:"sm"})),children:"新增用户"})]})}),b.current&&e.jsx(ct,{open:v,onOpenChange:$,title:e.jsxs("span",{children:["您确定要删除用户 ",e.jsx(N,{children:b.current.username})," 吗？"]}),onConfirm:k}),b.current&&e.jsx(jt,{open:w,onOpenChange:h,user:b.current,updateState:m})]})}function Vt(){ot("用户管理");const[t,a]=Be(),[n,c]=M.useState([]),{data:r,error:u,loading:s,requestData:o,discardRequest:i,updateState:x}=Q(G),{loading:g,requestData:f}=Q(G),{toast:m}=re(),v="/api/v1/users";rt(()=>{const l=Date.now();return Ce().then(),()=>i({url:v},l)});const $=Number(t.get(B))||at,w=Number(t.get(K))||nt,h=t.get(z)||"createdAt",b=t.get(Y)||"desc",k=t.get("username")||"",p=t.get("nickname")||"",C=t.get("status")||"",L=t.get("authority")||"";async function Ce(){const l={pageNum:$,pageSize:w};return h&&(l.sortColumn=h),b&&(l.sortOrder=b==="asc"?"asc":"desc"),k&&(l.username=k),p&&(l.nickname=p),C&&(l.status=C),L&&(l.authority=L),await o({url:v,urlParams:l})}function ye(){const l=((r==null?void 0:r.list)||[]).filter((j,S)=>n.includes(S)).map(j=>j.id);if(l.length===0){m({title:"未选中任何行",description:"请先选中要操作的行",variant:"destructive"});return}m({title:"选中的行",description:e.jsxs("span",{children:["被选中的行 ID(s)：",e.jsx(N,{children:l.join(", ")})]})})}async function Se(l,j){return await f({url:`/api/v1/users/${l}/status`,method:"PUT",bodyData:{status:j}})}async function ve(l){return await f({url:`/api/v1/users/${l}`,method:"DELETE"})}async function Ee(l,j){const S=j?0:1,{status:E,error:D}=await Se(l.id,S);if(E!==204){m({title:"更新账号状态失败",description:D,variant:"destructive"});return}x(y=>{if(!y.data)return y;const H=y.data.list.map(A=>(A.id===l.id&&(A.status=S,A.updatedAt=be(new Date,"yyyy-MM-dd HH:mm:ss")),A));return{...y,data:{...y.data,list:H}}}),m({title:"更新账号状态成功",description:e.jsxs("span",{children:[j?"禁用":"启用"," ",e.jsx(N,{children:l.username})," 账号"]})})}async function De(l){const{id:j,username:S}=l,{status:E,error:D}=await ve(j);if(E!==204){m({title:"删除用户失败",description:D,variant:"destructive"});return}x(y=>{if(!y.data)return y;const H=y.data.list.filter(A=>A.id!==j);return{...y,data:{...y.data,total:y.data.total-1,list:H}}}),m({title:"删除用户成功",description:e.jsxs("span",{children:["成功删除用户 ",e.jsx(N,{children:S})]})})}function Re(l){t.set(B,String(l.pageNum)),t.set(K,String(l.pageSize)),a(t,{replace:!0})}const _e=l=>{var E,D;t.delete("createdAt"),t.delete("updatedAt");const j=((E=l[0])==null?void 0:E.id)==="更新时间"?"updatedAt":"createdAt",S=((D=l[0])==null?void 0:D.desc)===!0?"desc":"asc";j&&(t.set(z,j),t.set(Y,S),a(t))};function Ne(l){t.delete(B),t.delete(K),t.delete("username"),t.delete("nickname"),t.delete("status"),t.delete("authority");const{username:j,nickname:S,status:E,authority:D}=l;j&&t.set("username",j),S&&t.set("nickname",S),E&&t.set("status",E),D&&t.set("authority",D),a(t,{replace:!0})}return e.jsxs(Ze,{className:"mx-auto h-full w-full",children:[e.jsxs(Ve,{children:[e.jsx(Je,{children:"用户管理"}),e.jsx(et,{children:"可登录系统的所有账号信息"})]}),e.jsxs(tt,{children:[e.jsx(pt,{queryParams:{username:k,nickname:p,status:C,authority:L},loading:s,onSearch:Ne}),e.jsx(Ot,{data:(r==null?void 0:r.list)||[],error:u,loading:s,submitting:g,pagination:{pageNum:$,pageSize:w,total:(r==null?void 0:r.total)||0},onPaginate:Re,sortColumn:{id:t.get(z)==="updatedAt"?"更新时间":"创建时间",desc:t.get(Y)!=="asc"},onSorting:_e,onSelect:c,onShowSelection:ye,onChangeStatus:Ee,onDeleteUser:De,updatePaging:x})]})]})}export{Vt as default};
