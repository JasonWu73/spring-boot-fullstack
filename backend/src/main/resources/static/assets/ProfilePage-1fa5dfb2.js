import{a as j,b as F,j as s,E as U,B as E,R as D,e as T,f as I,r as g,P as b}from"./index-f29c37fe.js";import{t as q,z as n}from"./index-a1d6eb7d.js";import{u as R,C as W,a as B,b as _,c as z,d as H,F as K,e as o}from"./CustomFormField-a6762e0b.js";import{A as L,a as V,b as Y,c as G}from"./Accordion-a5e4c1b1.js";import{A as J,a as M,b as O}from"./Alert-fc7e4ad1.js";import{S as l}from"./Skeleton-15b235d6.js";import{u as Q}from"./use-refresh-e248a172.js";import{u as X}from"./use-title-bfe6ef72.js";import{e as P}from"./rsa-fd848fa5.js";const Z=n.object({nickname:n.string().min(1,"必须输入昵称").trim(),oldPassword:n.string().trim(),newPassword:n.string().trim(),confirmPassword:n.string().trim()}).refine(({oldPassword:e,newPassword:r})=>e&&r||!e&&!r,{message:"新旧密码必须同时存在或不存在",path:["newPassword"]}).refine(({newPassword:e,confirmPassword:r})=>e===r,{message:"新密码和确认密码必须相同",path:["confirmPassword"]}),$={nickname:"",oldPassword:"",newPassword:"",confirmPassword:""};function ds(){var f,x,h,w;X("个人资料");const e=R({resolver:q(Z),defaultValues:$}),{data:r,error:c,loading:d,requestData:N,discardRequest:y}=j(g),{loading:m,requestData:v}=j(g),{toast:p}=F(),u="/api/v1/users/me";Q(()=>{const a=Date.now();return A().then(({data:t})=>{t&&k(t)}),()=>y({url:u},a)});async function A(){return await N({url:u})}function k(a){e.reset({nickname:a.nickname,oldPassword:"",newPassword:"",confirmPassword:""})}async function S({nickname:a,oldPassword:t,newPassword:i}){return await v({url:"/api/v1/users/me",method:"PUT",bodyData:{nickname:a,oldPassword:t?P(b,t):null,newPassword:i?P(b,i):null}})}async function C(a){if(!r)return;const{status:t,error:i}=await S({nickname:a.nickname,oldPassword:a.oldPassword,newPassword:a.newPassword});if(t!==204){p({title:"更新资料失败",description:i,variant:"destructive"});return}p({title:"更新资料成功",description:s.jsx("span",{children:"您已成功更新个人资料。"})}),a.newPassword&&T(),I(a.nickname)}return s.jsxs(W,{className:"mx-auto w-full md:w-4/5 lg:w-2/3",children:[s.jsxs(B,{children:[s.jsx(_,{children:"个人资料"}),s.jsx(z,{children:"您的个人资料"})]}),s.jsxs(H,{children:[d&&s.jsx(ss,{}),!d&&s.jsx(K,{...e,children:s.jsxs("form",{onSubmit:e.handleSubmit(C),className:"flex flex-col gap-4",children:[c&&s.jsxs(J,{variant:"destructive",children:[s.jsx(U,{className:"h-4 w-4"}),s.jsx(M,{children:"获取个人资料失败"}),s.jsx(O,{children:c})]}),s.jsx(o,{control:e.control,name:"nickname",type:"text",label:"昵称",labelWidth:60,placeholder:"昵称",isError:(f=e.getFieldState("nickname"))==null?void 0:f.invalid}),s.jsx(L,{type:"single",collapsible:!0,children:s.jsxs(V,{value:"item-1",children:[s.jsx(Y,{children:"修改密码"}),s.jsxs(G,{className:"space-y-2 pt-2",children:[s.jsx(o,{control:e.control,name:"oldPassword",type:"password",label:"旧密码",labelWidth:60,placeholder:"旧密码，不需要修改密码则不用填",isError:(x=e.getFieldState("oldPassword"))==null?void 0:x.invalid}),s.jsx(o,{control:e.control,name:"newPassword",type:"password",label:"新密码",labelWidth:60,placeholder:"新密码，不需要修改密码则不用填",isError:(h=e.getFieldState("newPassword"))==null?void 0:h.invalid}),s.jsx(o,{control:e.control,name:"confirmPassword",type:"password",label:"确认密码",labelWidth:60,placeholder:"确认密码，不需要修改密码则不用填",isError:(w=e.getFieldState("confirmPassword"))==null?void 0:w.invalid})]})]})}),s.jsx("div",{className:"flex gap-2 sm:justify-end",children:s.jsxs(E,{type:"submit",className:"self-end",disabled:m,children:[m&&s.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"提交"]})})]})})]})]})}function ss(){return s.jsxs("div",{className:"flex flex-col gap-4",children:[Array.from({length:1},(e,r)=>s.jsx("div",{className:"flex flex-col gap-4",children:s.jsxs("div",{className:"grid grid-flow-row items-center gap-2 lg:grid-cols-[auto_1fr]",children:[s.jsx(l,{className:"h-9 w-32"}),s.jsx(l,{className:"h-9"})]})},r)),s.jsx("div",{className:"border-b pb-4",children:s.jsx(l,{className:"h-9 w-full"})}),s.jsx("div",{className:"flex gap-2 sm:justify-end",children:s.jsx(l,{className:"h-9 w-20 self-end"})})]})}export{ds as default};
