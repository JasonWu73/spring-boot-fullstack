import{c as Re,q as G,f as T,j as e,B as I,R as ne,M as re,Q as ce,T as oe,V as Q,W as X,$ as ie,r as o,H as le,C as de,k as H,_ as M,F as z,G as Pe,X as ue,Y as he,h as U,Z as _e,a as Z,b as J,d as ee,E as Ne,P as Ae,a0 as Y,a1 as V,L as te,p as Ie,a2 as Me,a3 as Te,a4 as Ue,a5 as Fe,a6 as K,a7 as Oe,g as Le}from"./index-d3df7cba.js";import{u as fe,F as me,e as L,f as se,D as He,g as Be,h as Ke,i as qe,j as ze,k as Ye,l as Ve,m as be,B as q,C as We,a as Ge,b as Qe,c as Xe,d as Ze}from"./CustomFormField-e6dde6d7.js";import{C as N}from"./Code-19be8e84.js";import{D as Je,a as D,b as et,c as tt}from"./DataTableColumnHeader-a53f2bec.js";import{u as st}from"./use-title-b14c12fb.js";import{z as P,t as pe}from"./index-09033c31.js";import{C as at}from"./ConfirmDialog-3e0c24f8.js";import{A as nt,a as rt,b as ct}from"./Alert-52768be9.js";import{e as ot}from"./rsa-fd848fa5.js";import"./Skeleton-053f620d.js";/**
 * @license lucide-react v0.293.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=Re("MoreHorizontal",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]),lt=[{value:"",label:"全部"},{value:"0",label:"禁用"},{value:"1",label:"启用"}],dt=[{value:"",label:"全部"},re,ce,oe],ut=P.object({username:P.string().trim(),nickname:P.string().trim(),status:P.string().trim(),authority:P.string().trim()}),ae={username:"",nickname:"",status:"",authority:""};function ht({loading:s}){var b,l,f,d;const n=fe({resolver:pe(ut),defaultValues:ae}),[t,x]=G();T.useEffect(()=>{const h=t.get("username")||"",i=t.get("nickname")||"",w=t.get("status")||"",v=t.get("authority")||"";n.setValue("username",h),n.setValue("nickname",i),n.setValue("status",w),n.setValue("authority",v)},[t,n]);function r(h){t.delete(Q),t.delete(X),t.delete("username"),t.delete("username"),t.delete("nickname"),t.delete("status"),t.delete("authority"),h.username&&t.set("username",h.username),h.nickname&&t.set("nickname",h.nickname),h.status&&t.set("status",h.status),h.authority&&t.set("authority",h.authority),x(t,{replace:!0})}function m(){n.reset(),r(ae)}return e.jsx(me,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(r),className:"mb-8 flex flex-wrap items-center gap-4",children:[e.jsx(L,{control:n.control,name:"username",type:"text",label:"用户名",labelWidth:45,placeholder:"用户名",isError:(b=n.getFieldState("username"))==null?void 0:b.invalid}),e.jsx(L,{control:n.control,name:"nickname",type:"text",label:"昵称",labelWidth:45,placeholder:"昵称",isError:(l=n.getFieldState("nickname"))==null?void 0:l.invalid}),e.jsx(se,{control:n.control,name:"status",label:"状态",labelWidth:45,options:lt,isError:(f=n.getFieldState("status"))==null?void 0:f.invalid}),e.jsx(se,{control:n.control,name:"authority",label:"权限",labelWidth:45,options:dt,isError:(d=n.getFieldState("authority"))==null?void 0:d.invalid}),e.jsxs(I,{type:"submit",className:"self-end",disabled:s,children:[s&&e.jsx(ne,{className:"mr-2 h-4 w-4 animate-spin"}),"查询"]}),e.jsx(I,{onClick:m,type:"reset",variant:"outline",className:"self-end",disabled:s,children:"重置"})]})})}const xe="Checkbox",[ft,Kt]=ie(xe),[mt,bt]=ft(xe),pt=o.forwardRef((s,n)=>{const{__scopeCheckbox:t,name:x,checked:r,defaultChecked:m,required:b,disabled:l,value:f="on",onCheckedChange:d,...h}=s,[i,w]=o.useState(null),v=le(n,u=>w(u)),E=o.useRef(!1),k=i?!!i.closest("form"):!0,[c=!1,p]=de({prop:r,defaultProp:m,onChange:d}),j=o.useRef(c);return o.useEffect(()=>{const u=i==null?void 0:i.form;if(u){const y=()=>p(j.current);return u.addEventListener("reset",y),()=>u.removeEventListener("reset",y)}},[i,p]),o.createElement(mt,{scope:t,state:c,disabled:l},o.createElement(H.button,M({type:"button",role:"checkbox","aria-checked":A(c)?"mixed":c,"aria-required":b,"data-state":ke(c),"data-disabled":l?"":void 0,disabled:l,value:f},h,{ref:v,onKeyDown:z(s.onKeyDown,u=>{u.key==="Enter"&&u.preventDefault()}),onClick:z(s.onClick,u=>{p(y=>A(y)?!0:!y),k&&(E.current=u.isPropagationStopped(),E.current||u.stopPropagation())})})),k&&o.createElement(gt,{control:i,bubbles:!E.current,name:x,value:f,checked:c,required:b,disabled:l,style:{transform:"translateX(-100%)"}}))}),xt="CheckboxIndicator",kt=o.forwardRef((s,n)=>{const{__scopeCheckbox:t,forceMount:x,...r}=s,m=bt(xt,t);return o.createElement(Pe,{present:x||A(m.state)||m.state===!0},o.createElement(H.span,M({"data-state":ke(m.state),"data-disabled":m.disabled?"":void 0},r,{ref:n,style:{pointerEvents:"none",...s.style}})))}),gt=s=>{const{control:n,checked:t,bubbles:x=!0,...r}=s,m=o.useRef(null),b=ue(t),l=he(n);return o.useEffect(()=>{const f=m.current,d=window.HTMLInputElement.prototype,i=Object.getOwnPropertyDescriptor(d,"checked").set;if(b!==t&&i){const w=new Event("click",{bubbles:x});f.indeterminate=A(t),i.call(f,A(t)?!1:t),f.dispatchEvent(w)}},[b,t,x]),o.createElement("input",M({type:"checkbox","aria-hidden":!0,defaultChecked:A(t)?!1:t},r,{tabIndex:-1,ref:m,style:{...s.style,...l,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function A(s){return s==="indeterminate"}function ke(s){return A(s)?"indeterminate":s?"checked":"unchecked"}const ge=pt,$t=kt,W=o.forwardRef(({className:s,...n},t)=>e.jsx(ge,{ref:t,className:U("peer h-4 w-4 shrink-0 rounded-sm border border-slate-800 shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-sky-500 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:border-sky-500 data-[state=checked]:bg-sky-500 data-[state=checked]:text-slate-50 dark:border-slate-100  dark:focus-visible:ring-slate-700 dark:data-[state=checked]:bg-slate-50 dark:data-[state=checked]:text-sky-900",s),...n,children:e.jsx($t,{className:U("flex items-center justify-center text-current"),children:e.jsx(_e,{className:"h-4 w-4"})})}));W.displayName=ge.displayName;const $e="Switch",[jt,qt]=ie($e),[wt,Ct]=jt($e),yt=o.forwardRef((s,n)=>{const{__scopeSwitch:t,name:x,checked:r,defaultChecked:m,required:b,disabled:l,value:f="on",onCheckedChange:d,...h}=s,[i,w]=o.useState(null),v=le(n,j=>w(j)),E=o.useRef(!1),k=i?!!i.closest("form"):!0,[c=!1,p]=de({prop:r,defaultProp:m,onChange:d});return o.createElement(wt,{scope:t,checked:c,disabled:l},o.createElement(H.button,M({type:"button",role:"switch","aria-checked":c,"aria-required":b,"data-state":je(c),"data-disabled":l?"":void 0,disabled:l,value:f},h,{ref:v,onClick:z(s.onClick,j=>{p(u=>!u),k&&(E.current=j.isPropagationStopped(),E.current||j.stopPropagation())})})),k&&o.createElement(St,{control:i,bubbles:!E.current,name:x,value:f,checked:c,required:b,disabled:l,style:{transform:"translateX(-100%)"}}))}),Et="SwitchThumb",vt=o.forwardRef((s,n)=>{const{__scopeSwitch:t,...x}=s,r=Ct(Et,t);return o.createElement(H.span,M({"data-state":je(r.checked),"data-disabled":r.disabled?"":void 0},x,{ref:n}))}),St=s=>{const{control:n,checked:t,bubbles:x=!0,...r}=s,m=o.useRef(null),b=ue(t),l=he(n);return o.useEffect(()=>{const f=m.current,d=window.HTMLInputElement.prototype,i=Object.getOwnPropertyDescriptor(d,"checked").set;if(b!==t&&i){const w=new Event("click",{bubbles:x});i.call(f,t),f.dispatchEvent(w)}},[b,t,x]),o.createElement("input",M({type:"checkbox","aria-hidden":!0,defaultChecked:t},r,{tabIndex:-1,ref:m,style:{...s.style,...l,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function je(s){return s?"checked":"unchecked"}const we=yt,Dt=vt,Ce=o.forwardRef(({className:s,...n},t)=>e.jsx(we,{className:U("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 focus-visible:ring-offset-white disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-green-500 data-[state=unchecked]:bg-slate-200 dark:focus-visible:ring-slate-300 dark:focus-visible:ring-offset-slate-950 dark:data-[state=checked]:bg-green-600 dark:data-[state=unchecked]:bg-slate-800",s),...n,ref:t,children:e.jsx(Dt,{className:U("pointer-events-none block h-4 w-4 rounded-full bg-white shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0 dark:bg-slate-950")})}));Ce.displayName=we.displayName;const Rt=P.object({password:P.string().min(1,"必须输入密码"),confirmPassword:P.string().min(1,"必须输入确认密码")}).refine(({password:s,confirmPassword:n})=>s===n,{message:"密码和确认密码必须相同",path:["confirmPassword"]}),Pt={password:"",confirmPassword:""};function _t({open:s,onOpenChange:n,user:t,updateState:x}){var k,c;const r=fe({resolver:pe(Rt),defaultValues:Pt}),{requestApi:m}=Z(),{error:b,loading:l,fetchData:f,updateState:d}=J(m),{toast:h}=ee();async function i(p,j){return await f({url:`/api/v1/users/${p}/password`,method:"PUT",bodyData:{password:ot(Ae,j)}})}async function w(p){const{status:j}=await i(t.id,p.password);j===204&&(x(u=>{if(!u.data)return u;const y=u.data.list.map(R=>R.id===t.id?{...R,updatedAt:be(new Date,"yyyy-MM-dd HH:mm:ss")}:R);return{...u,data:{...u.data,list:y}}}),v(),n(!1),h({title:"重置用户密码成功",description:e.jsxs("span",{children:["成功重置用户 ",e.jsx(N,{children:t.username})," 登录密码"]})}))}function v(){r.reset(),d(p=>({...p,error:void 0}))}function E(p){p||v(),n(p)}return e.jsx(He,{open:s,onOpenChange:E,children:e.jsxs(Be,{className:"sm:max-w-[425px]",children:[e.jsxs(Ke,{children:[e.jsxs(qe,{children:["重置用户 ",e.jsx(N,{children:t.username})," 密码"]}),e.jsx(ze,{children:"重置后，用户将使用新密码登录系统"})]}),e.jsx(me,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(w),autoComplete:"off",className:"flex flex-col gap-4",children:[!l&&b&&e.jsxs(nt,{variant:"destructive",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(rt,{children:"重置用户密码失败"}),e.jsx(ct,{children:b})]}),e.jsx(L,{control:r.control,name:"password",type:"password",label:"密码",labelWidth:60,placeholder:"密码",isError:(k=r.getFieldState("password"))==null?void 0:k.invalid}),e.jsx(L,{control:r.control,name:"confirmPassword",type:"password",label:"确认密码",labelWidth:60,placeholder:"确认密码",isError:(c=r.getFieldState("confirmPassword"))==null?void 0:c.invalid}),e.jsxs(Ye,{children:[e.jsx(Ve,{asChild:!0,children:e.jsx(I,{type:"button",variant:"outline",disabled:l,children:"取消"})}),e.jsxs(I,{type:"submit",disabled:l,children:[l&&e.jsx(ne,{className:"mr-2 h-4 w-4 animate-spin"}),"提交"]})]})]})})]})})}function Nt({users:s,error:n,loading:t,pageNum:x,pageSize:r,total:m,onSelect:b,onShowSelection:l,updateState:f}){const[d,h]=G(),[i,w]=T.useState(!1),[v,E]=T.useState(!1),k=T.useRef(null),{isRoot:c,requestApi:p}=Z(),{loading:j,fetchData:u}=J(p),{toast:y}=ee();function R(){const g=[{id:"选择",header:({table:a})=>e.jsx(W,{checked:a.getIsAllPageRowsSelected(),onCheckedChange:$=>a.toggleAllPageRowsSelected(!!$),"aria-label":"全选"}),cell:({row:a})=>e.jsx(W,{checked:a.getIsSelected(),onCheckedChange:$=>a.toggleSelected(!!$),"aria-label":"选择行"}),enableSorting:!1,enableHiding:!1},{id:"ID",accessorKey:"id",header:({column:a})=>e.jsx(D,{column:a,title:"ID"})},{id:"昵称",header:({column:a})=>e.jsx(D,{column:a,title:"昵称"}),cell:({row:a})=>a.original.nickname},{id:"用户名",accessorKey:"username",header:({column:a})=>e.jsxs(D,{column:a,children:["用户名",e.jsx("span",{className:"ml-1 text-xs text-slate-500",children:"（可用作登录）"})]}),cell:({row:a})=>e.jsx(N,{children:a.original.username})},{id:"账号状态",header:({column:a})=>e.jsxs(D,{column:a,children:["账号状态",e.jsx("span",{className:"ml-1 text-xs text-slate-500",children:"（禁用后不可登录）"})]}),cell:({row:a})=>{const $=a.original,C=$.status===1;return e.jsx(Ce,{checked:C,disabled:j,onCheckedChange:()=>Ee($,C)})}},{id:"权限",header:({column:a})=>e.jsx(D,{column:a,title:"权限"}),cell:({row:a})=>{const $=a.original;return e.jsx("div",{className:"space-x-1",children:$.authorities.map(C=>C===re.value?e.jsx(q,{variant:"destructive",children:"超级管理员"},C):C===ce.value?e.jsx(q,{children:"管理员"},C):C===oe.value?e.jsx(q,{variant:"outline",children:"用户"},C):null)})}},{id:"创建时间",accessorKey:"createdAt",header:({column:a})=>e.jsx(D,{sortable:!0,column:a,title:"创建时间"})},{id:"更新时间",accessorKey:"updatedAt",header:({column:a})=>e.jsx(D,{sortable:!0,column:a,title:"更新时间"})},{id:"备注",accessorKey:"remark",header:({column:a})=>e.jsx(D,{column:a,title:"备注"})},{id:"操作",header:({column:a})=>e.jsx(D,{column:a,title:"操作"}),cell:({row:a})=>{const $=a.original;return e.jsxs(Me,{children:[e.jsx(Te,{asChild:!0,disabled:j,children:e.jsx(I,{variant:"ghost",className:"h-8 w-8 p-0",children:e.jsx(it,{className:"h-4 w-4"})})}),e.jsxs(Ue,{align:"end",children:[e.jsx(Fe,{children:"操作"}),e.jsx(K,{className:"p-0",children:e.jsx(te,{to:`/users/${$.id}`,className:"inline-block w-full px-2 py-1.5",children:"查看详情"})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(Oe,{}),e.jsx(K,{className:"p-0",children:e.jsx("button",{onClick:()=>{w(!0),k.current=$},className:"inline-block w-full px-2 py-1.5 text-left text-red-500 dark:text-red-600",children:"删除用户"})}),e.jsx(K,{className:"p-0",children:e.jsx("button",{onClick:()=>{E(!0),k.current=$},className:"inline-block w-full px-2 py-1.5 text-left text-red-500 dark:text-red-600",children:"重置密码"})})]})]})]})}}];return c?g:g.filter(a=>a.id!=="选择")}async function F(g,a){return await u({url:`/api/v1/users/${g}/status`,method:"PUT",bodyData:{status:a}})}async function ye(g){return await u({url:`/api/v1/users/${g}`,method:"DELETE"})}async function Ee(g,a){const $=a?0:1,{status:C,error:S}=await F(g.id,$);if(C!==204){y({title:"更新账号状态失败",description:S,variant:"destructive"});return}f(_=>{if(!_.data)return _;const B=_.data.list.map(O=>(O.id===g.id&&(O.status=$,O.updatedAt=be(new Date,"yyyy-MM-dd HH:mm:ss")),O));return{..._,data:{..._.data,list:B}}}),y({title:"更新账号状态成功",description:e.jsxs("span",{children:[a?"禁用":"启用"," ",e.jsx(N,{children:g.username})," 账号"]})})}async function ve(){if(!k.current)return;const{id:g,username:a}=k.current,{status:$,error:C}=await ye(g);if($!==204){y({title:"删除用户失败",description:C,variant:"destructive"});return}f(S=>{if(!S.data)return S;const _=S.data.list.filter(B=>B.id!==g);return{...S,data:{...S.data,total:S.data.total-1,list:_}}}),y({title:"删除用户成功",description:e.jsxs("span",{children:["成功删除用户 ",e.jsx(N,{children:a})]})})}function Se(g){d.set(Q,String(g.pageNum)),d.set(X,String(g.pageSize)),h(d,{replace:!0})}const De=g=>{var C,S;d.delete("createdAt"),d.delete("updatedAt");const a=((C=g[0])==null?void 0:C.id)==="更新时间"?"updatedAt":"createdAt",$=((S=g[0])==null?void 0:S.desc)===!0?"desc":"asc";a&&(d.set(Y,a),d.set(V,$),h(d))};return e.jsxs(e.Fragment,{children:[e.jsx(Je,{columns:R(),data:s,error:n,loading:t,pagination:{pageNum:x,pageSize:r,total:m},onPaginate:Se,sortColumn:{id:d.get(Y)==="updatedAt"?"更新时间":"创建时间",desc:d.get(V)!=="asc"},onSorting:De,enableRowSelection:!0,onSelect:b,children:c&&e.jsxs("div",{children:[e.jsx(I,{onClick:l,size:"sm",variant:"secondary",children:"查看被选中的行"}),e.jsx(te,{to:"/users/add",className:U("ml-2",Ie({variant:"default",size:"sm"})),children:"新增用户"})]})}),k.current&&e.jsx(at,{open:i,onOpenChange:w,title:e.jsxs("span",{children:["您确定要删除用户 ",e.jsx(N,{children:k.current.username})," 吗？"]}),onConfirm:ve}),k.current&&e.jsx(_t,{open:v,onOpenChange:E,user:k.current,updateState:f})]})}function zt(){st("用户管理");const[s]=G(),[n,t]=T.useState([]),{requestApi:x}=Z(),{data:r,error:m,loading:b,fetchData:l,discardFetch:f,updateState:d}=J(x),{toast:h}=ee(),i="/api/v1/users";Le(()=>{const c=Date.now();return E().then(),()=>f({url:i},c)});const w=Number(s.get(Q))||et,v=Number(s.get(X))||tt;async function E(){const c={pageNum:w,pageSize:v},p=s.get(Y)||"createdAt",j=s.get(V)||"desc",u=s.get("username"),y=s.get("nickname"),R=s.get("status"),F=s.get("authority");return p&&(c.sortColumn=p),j&&(c.sortOrder=j==="asc"?"asc":"desc"),u&&(c.username=u),y&&(c.nickname=y),R&&(c.status=R),F&&(c.authority=F),await l({url:i,urlParams:c})}function k(){const c=((r==null?void 0:r.list)||[]).filter((p,j)=>n.includes(j)).map(p=>p.id);if(c.length===0){h({title:"未选中任何行",description:"请先选中要操作的行",variant:"destructive"});return}h({title:"选中的行",description:e.jsxs("span",{children:["被选中的行 ID(s)：",e.jsx(N,{children:c.join(", ")})]})})}return e.jsxs(We,{className:"mx-auto h-full w-full",children:[e.jsxs(Ge,{children:[e.jsx(Qe,{children:"用户管理"}),e.jsx(Xe,{children:"可登录系统的所有账号信息"})]}),e.jsxs(Ze,{children:[e.jsx(ht,{loading:b}),e.jsx(Nt,{users:(r==null?void 0:r.list)||[],error:m,loading:b,pageNum:w,pageSize:v,total:(r==null?void 0:r.total)||0,onSelect:t,onShowSelection:k,updateState:d})]})]})}export{zt as default};
