import{c as De,p as G,e as T,j as e,B as I,R as ne,A as re,C as ce,D as Q,F as X,$ as oe,r as o,G as ie,H as de,i as O,_ as M,I as Y,J as Re,K as le,M as ue,g as F,Q as Pe,a as Z,b as J,d as ee,E as _e,P as Ne,T as z,V,L as te,o as Ae,W as Ie,X as Me,Y as Te,Z as Fe,a0 as Ue,a1 as K,a2 as Be,f as Le}from"./index-990c888e.js";import{u as he,F as fe,e as L,f as se,D as Oe,g as He,h as Ke,i as qe,j as Ye,k as ze,l as Ve,m as be,B as q,C as We,a as Ge,b as Qe,c as Xe,d as Ze}from"./CustomFormField-52ac9235.js";import{C as N}from"./Code-4e3ef1a6.js";import{D as Je,a as D,b as et,c as tt}from"./DataTableColumnHeader-fcb4673a.js";import{u as st}from"./use-title-28640cc3.js";import{z as P,t as me}from"./index-e8c517f4.js";import{C as at}from"./ConfirmDialog-5913a5c9.js";import{A as nt,a as rt,b as ct}from"./Alert-dbe85c13.js";import{e as ot}from"./rsa-fd848fa5.js";import"./Skeleton-68e2d402.js";/**
 * @license lucide-react v0.293.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=De("MoreHorizontal",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]),dt=[{value:"",label:"全部"},{value:"0",label:"禁用"},{value:"1",label:"启用"}],lt=[{value:"",label:"全部"},re,ce],ut=P.object({username:P.string().trim(),nickname:P.string().trim(),status:P.string().trim(),authority:P.string().trim()}),ae={username:"",nickname:"",status:"",authority:""};function ht({loading:s}){var m,d,f,l;const n=he({resolver:me(ut),defaultValues:ae}),[t,x]=G();T.useEffect(()=>{const h=t.get("username")||"",i=t.get("nickname")||"",w=t.get("status")||"",v=t.get("authority")||"";n.setValue("username",h),n.setValue("nickname",i),n.setValue("status",w),n.setValue("authority",v)},[t,n]);function r(h){t.delete(Q),t.delete(X),t.delete("username"),t.delete("username"),t.delete("nickname"),t.delete("status"),t.delete("authority"),h.username&&t.set("username",h.username),h.nickname&&t.set("nickname",h.nickname),h.status&&t.set("status",h.status),h.authority&&t.set("authority",h.authority),x(t,{replace:!0})}function b(){n.reset(),r(ae)}return e.jsx(fe,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(r),className:"mb-8 flex flex-wrap items-center gap-4",children:[e.jsx(L,{control:n.control,name:"username",type:"text",label:"用户名",labelWidth:45,placeholder:"用户名",isError:(m=n.getFieldState("username"))==null?void 0:m.invalid}),e.jsx(L,{control:n.control,name:"nickname",type:"text",label:"昵称",labelWidth:45,placeholder:"昵称",isError:(d=n.getFieldState("nickname"))==null?void 0:d.invalid}),e.jsx(se,{control:n.control,name:"status",label:"状态",labelWidth:45,options:dt,isError:(f=n.getFieldState("status"))==null?void 0:f.invalid}),e.jsx(se,{control:n.control,name:"authority",label:"权限",labelWidth:45,options:lt,isError:(l=n.getFieldState("authority"))==null?void 0:l.invalid}),e.jsxs(I,{type:"submit",className:"self-end",disabled:s,children:[s&&e.jsx(ne,{className:"mr-2 h-4 w-4 animate-spin"}),"查询"]}),e.jsx(I,{onClick:b,type:"reset",variant:"outline",className:"self-end",disabled:s,children:"重置"})]})})}const pe="Checkbox",[ft,Kt]=oe(pe),[bt,mt]=ft(pe),pt=o.forwardRef((s,n)=>{const{__scopeCheckbox:t,name:x,checked:r,defaultChecked:b,required:m,disabled:d,value:f="on",onCheckedChange:l,...h}=s,[i,w]=o.useState(null),v=ie(n,u=>w(u)),E=o.useRef(!1),k=i?!!i.closest("form"):!0,[c=!1,p]=de({prop:r,defaultProp:b,onChange:l}),j=o.useRef(c);return o.useEffect(()=>{const u=i==null?void 0:i.form;if(u){const C=()=>p(j.current);return u.addEventListener("reset",C),()=>u.removeEventListener("reset",C)}},[i,p]),o.createElement(bt,{scope:t,state:c,disabled:d},o.createElement(O.button,M({type:"button",role:"checkbox","aria-checked":A(c)?"mixed":c,"aria-required":m,"data-state":xe(c),"data-disabled":d?"":void 0,disabled:d,value:f},h,{ref:v,onKeyDown:Y(s.onKeyDown,u=>{u.key==="Enter"&&u.preventDefault()}),onClick:Y(s.onClick,u=>{p(C=>A(C)?!0:!C),k&&(E.current=u.isPropagationStopped(),E.current||u.stopPropagation())})})),k&&o.createElement(gt,{control:i,bubbles:!E.current,name:x,value:f,checked:c,required:m,disabled:d,style:{transform:"translateX(-100%)"}}))}),xt="CheckboxIndicator",kt=o.forwardRef((s,n)=>{const{__scopeCheckbox:t,forceMount:x,...r}=s,b=mt(xt,t);return o.createElement(Re,{present:x||A(b.state)||b.state===!0},o.createElement(O.span,M({"data-state":xe(b.state),"data-disabled":b.disabled?"":void 0},r,{ref:n,style:{pointerEvents:"none",...s.style}})))}),gt=s=>{const{control:n,checked:t,bubbles:x=!0,...r}=s,b=o.useRef(null),m=le(t),d=ue(n);return o.useEffect(()=>{const f=b.current,l=window.HTMLInputElement.prototype,i=Object.getOwnPropertyDescriptor(l,"checked").set;if(m!==t&&i){const w=new Event("click",{bubbles:x});f.indeterminate=A(t),i.call(f,A(t)?!1:t),f.dispatchEvent(w)}},[m,t,x]),o.createElement("input",M({type:"checkbox","aria-hidden":!0,defaultChecked:A(t)?!1:t},r,{tabIndex:-1,ref:b,style:{...s.style,...d,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function A(s){return s==="indeterminate"}function xe(s){return A(s)?"indeterminate":s?"checked":"unchecked"}const ke=pt,$t=kt,W=o.forwardRef(({className:s,...n},t)=>e.jsx(ke,{ref:t,className:F("peer h-4 w-4 shrink-0 rounded-sm border border-slate-800 shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-sky-500 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:border-sky-500 data-[state=checked]:bg-sky-500 data-[state=checked]:text-slate-50 dark:border-slate-100  dark:focus-visible:ring-slate-700 dark:data-[state=checked]:bg-slate-50 dark:data-[state=checked]:text-sky-900",s),...n,children:e.jsx($t,{className:F("flex items-center justify-center text-current"),children:e.jsx(Pe,{className:"h-4 w-4"})})}));W.displayName=ke.displayName;const ge="Switch",[jt,qt]=oe(ge),[wt,yt]=jt(ge),Ct=o.forwardRef((s,n)=>{const{__scopeSwitch:t,name:x,checked:r,defaultChecked:b,required:m,disabled:d,value:f="on",onCheckedChange:l,...h}=s,[i,w]=o.useState(null),v=ie(n,j=>w(j)),E=o.useRef(!1),k=i?!!i.closest("form"):!0,[c=!1,p]=de({prop:r,defaultProp:b,onChange:l});return o.createElement(wt,{scope:t,checked:c,disabled:d},o.createElement(O.button,M({type:"button",role:"switch","aria-checked":c,"aria-required":m,"data-state":$e(c),"data-disabled":d?"":void 0,disabled:d,value:f},h,{ref:v,onClick:Y(s.onClick,j=>{p(u=>!u),k&&(E.current=j.isPropagationStopped(),E.current||j.stopPropagation())})})),k&&o.createElement(St,{control:i,bubbles:!E.current,name:x,value:f,checked:c,required:m,disabled:d,style:{transform:"translateX(-100%)"}}))}),Et="SwitchThumb",vt=o.forwardRef((s,n)=>{const{__scopeSwitch:t,...x}=s,r=yt(Et,t);return o.createElement(O.span,M({"data-state":$e(r.checked),"data-disabled":r.disabled?"":void 0},x,{ref:n}))}),St=s=>{const{control:n,checked:t,bubbles:x=!0,...r}=s,b=o.useRef(null),m=le(t),d=ue(n);return o.useEffect(()=>{const f=b.current,l=window.HTMLInputElement.prototype,i=Object.getOwnPropertyDescriptor(l,"checked").set;if(m!==t&&i){const w=new Event("click",{bubbles:x});i.call(f,t),f.dispatchEvent(w)}},[m,t,x]),o.createElement("input",M({type:"checkbox","aria-hidden":!0,defaultChecked:t},r,{tabIndex:-1,ref:b,style:{...s.style,...d,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function $e(s){return s?"checked":"unchecked"}const je=Ct,Dt=vt,we=o.forwardRef(({className:s,...n},t)=>e.jsx(je,{className:F("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 focus-visible:ring-offset-white disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-green-500 data-[state=unchecked]:bg-slate-200 dark:focus-visible:ring-slate-300 dark:focus-visible:ring-offset-slate-950 dark:data-[state=checked]:bg-green-600 dark:data-[state=unchecked]:bg-slate-800",s),...n,ref:t,children:e.jsx(Dt,{className:F("pointer-events-none block h-4 w-4 rounded-full bg-white shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0 dark:bg-slate-950")})}));we.displayName=je.displayName;const Rt=P.object({password:P.string().min(1,"必须输入密码"),confirmPassword:P.string().min(1,"必须输入确认密码")}).refine(({password:s,confirmPassword:n})=>s===n,{message:"密码和确认密码必须相同",path:["confirmPassword"]}),Pt={password:"",confirmPassword:""};function _t({open:s,onOpenChange:n,user:t,updateState:x}){var k,c;const r=he({resolver:me(Rt),defaultValues:Pt}),{requestApi:b}=Z(),{error:m,loading:d,fetchData:f,updateState:l}=J(b),{toast:h}=ee();async function i(p,j){return await f({url:`/api/v1/users/${p}/password`,method:"PUT",bodyData:{password:ot(Ne,j)}})}async function w(p){const{status:j}=await i(t.id,p.password);j===204&&(x(u=>{if(!u.data)return u;const C=u.data.list.map(R=>R.id===t.id?{...R,updatedAt:be(new Date,"yyyy-MM-dd HH:mm:ss")}:R);return{...u,data:{...u.data,list:C}}}),v(),n(!1),h({title:"重置用户密码成功",description:e.jsxs("span",{children:["成功重置用户 ",e.jsx(N,{children:t.username})," 登录密码"]})}))}function v(){r.reset(),l(p=>({...p,error:void 0}))}function E(p){p||v(),n(p)}return e.jsx(Oe,{open:s,onOpenChange:E,children:e.jsxs(He,{className:"sm:max-w-[425px]",children:[e.jsxs(Ke,{children:[e.jsxs(qe,{children:["重置用户 ",e.jsx(N,{children:t.username})," 密码"]}),e.jsx(Ye,{children:"重置后，用户将使用新密码登录系统"})]}),e.jsx(fe,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(w),autoComplete:"off",className:"flex flex-col gap-4",children:[!d&&m&&e.jsxs(nt,{variant:"destructive",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx(rt,{children:"重置用户密码失败"}),e.jsx(ct,{children:m})]}),e.jsx(L,{control:r.control,name:"password",type:"password",label:"密码",labelWidth:60,placeholder:"密码",isError:(k=r.getFieldState("password"))==null?void 0:k.invalid}),e.jsx(L,{control:r.control,name:"confirmPassword",type:"password",label:"确认密码",labelWidth:60,placeholder:"确认密码",isError:(c=r.getFieldState("confirmPassword"))==null?void 0:c.invalid}),e.jsxs(ze,{children:[e.jsx(Ve,{asChild:!0,children:e.jsx(I,{type:"button",variant:"outline",disabled:d,children:"取消"})}),e.jsxs(I,{type:"submit",disabled:d,children:[d&&e.jsx(ne,{className:"mr-2 h-4 w-4 animate-spin"}),"提交"]})]})]})})]})})}function Nt({users:s,error:n,loading:t,pageNum:x,pageSize:r,total:b,onSelect:m,onShowSelection:d,updateState:f}){const[l,h]=G(),[i,w]=T.useState(!1),[v,E]=T.useState(!1),k=T.useRef(null),{isRoot:c,requestApi:p}=Z(),{loading:j,fetchData:u}=J(p),{toast:C}=ee();function R(){const g=[{id:"选择",header:({table:a})=>e.jsx(W,{checked:a.getIsAllPageRowsSelected(),onCheckedChange:$=>a.toggleAllPageRowsSelected(!!$),"aria-label":"全选"}),cell:({row:a})=>e.jsx(W,{checked:a.getIsSelected(),onCheckedChange:$=>a.toggleSelected(!!$),"aria-label":"选择行"}),enableSorting:!1,enableHiding:!1},{id:"ID",accessorKey:"id",header:({column:a})=>e.jsx(D,{column:a,title:"ID"})},{id:"昵称",header:({column:a})=>e.jsx(D,{column:a,title:"昵称"}),cell:({row:a})=>a.original.nickname},{id:"用户名",accessorKey:"username",header:({column:a})=>e.jsxs(D,{column:a,children:["用户名",e.jsx("span",{className:"ml-1 text-xs text-slate-500",children:"（可用作登录）"})]}),cell:({row:a})=>e.jsx(N,{children:a.original.username})},{id:"账号状态",header:({column:a})=>e.jsxs(D,{column:a,children:["账号状态",e.jsx("span",{className:"ml-1 text-xs text-slate-500",children:"（禁用后不可登录）"})]}),cell:({row:a})=>{const $=a.original,y=$.status===1;return e.jsx(we,{checked:y,disabled:j,onCheckedChange:()=>Ce($,y)})}},{id:"权限",header:({column:a})=>e.jsx(D,{column:a,title:"权限"}),cell:({row:a})=>{const $=a.original;return e.jsx("div",{className:"space-x-1",children:$.authorities.map(y=>y===Ie.value?e.jsx(q,{variant:"destructive",children:"超级管理员"},y):y===re.value?e.jsx(q,{children:"管理员"},y):y===ce.value?e.jsx(q,{variant:"outline",children:"用户"},y):null)})}},{id:"创建时间",accessorKey:"createdAt",header:({column:a})=>e.jsx(D,{sortable:!0,column:a,title:"创建时间"})},{id:"更新时间",accessorKey:"updatedAt",header:({column:a})=>e.jsx(D,{sortable:!0,column:a,title:"更新时间"})},{id:"备注",accessorKey:"remark",header:({column:a})=>e.jsx(D,{column:a,title:"备注"})},{id:"操作",header:({column:a})=>e.jsx(D,{column:a,title:"操作"}),cell:({row:a})=>{const $=a.original;return e.jsxs(Me,{children:[e.jsx(Te,{asChild:!0,disabled:j,children:e.jsx(I,{variant:"ghost",className:"h-8 w-8 p-0",children:e.jsx(it,{className:"h-4 w-4"})})}),e.jsxs(Fe,{align:"end",children:[e.jsx(Ue,{children:"操作"}),e.jsx(K,{className:"p-0",children:e.jsx(te,{to:`/users/${$.id}`,className:"inline-block w-full px-2 py-1.5",children:"查看详情"})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(Be,{}),e.jsx(K,{className:"p-0",children:e.jsx("button",{onClick:()=>{w(!0),k.current=$},className:"inline-block w-full px-2 py-1.5 text-left text-red-500 dark:text-red-600",children:"删除用户"})}),e.jsx(K,{className:"p-0",children:e.jsx("button",{onClick:()=>{E(!0),k.current=$},className:"inline-block w-full px-2 py-1.5 text-left text-red-500 dark:text-red-600",children:"重置密码"})})]})]})]})}}];return c?g:g.filter(a=>a.id!=="选择")}async function U(g,a){return await u({url:`/api/v1/users/${g}/status`,method:"PUT",bodyData:{status:a}})}async function ye(g){return await u({url:`/api/v1/users/${g}`,method:"DELETE"})}async function Ce(g,a){const $=a?0:1,{status:y,error:S}=await U(g.id,$);if(y!==204){C({title:"更新账号状态失败",description:S,variant:"destructive"});return}f(_=>{if(!_.data)return _;const H=_.data.list.map(B=>(B.id===g.id&&(B.status=$,B.updatedAt=be(new Date,"yyyy-MM-dd HH:mm:ss")),B));return{..._,data:{..._.data,list:H}}}),C({title:"更新账号状态成功",description:e.jsxs("span",{children:[a?"禁用":"启用"," ",e.jsx(N,{children:g.username})," 账号"]})})}async function Ee(){if(!k.current)return;const{id:g,username:a}=k.current,{status:$,error:y}=await ye(g);if($!==204){C({title:"删除用户失败",description:y,variant:"destructive"});return}f(S=>{if(!S.data)return S;const _=S.data.list.filter(H=>H.id!==g);return{...S,data:{...S.data,total:S.data.total-1,list:_}}}),C({title:"删除用户成功",description:e.jsxs("span",{children:["成功删除用户 ",e.jsx(N,{children:a})]})})}function ve(g){l.set(Q,String(g.pageNum)),l.set(X,String(g.pageSize)),h(l,{replace:!0})}const Se=g=>{var y,S;l.delete("createdAt"),l.delete("updatedAt");const a=((y=g[0])==null?void 0:y.id)==="更新时间"?"updatedAt":"createdAt",$=((S=g[0])==null?void 0:S.desc)===!0?"desc":"asc";a&&(l.set(z,a),l.set(V,$),h(l))};return e.jsxs(e.Fragment,{children:[e.jsx(Je,{columns:R(),data:s,error:n,loading:t,pagination:{pageNum:x,pageSize:r,total:b},onPaginate:ve,orderBy:{id:l.get(z)==="updatedAt"?"更新时间":"创建时间",desc:l.get(V)!=="asc"},onSorting:Se,enableRowSelection:!0,onSelect:m,children:c&&e.jsxs("div",{children:[e.jsx(I,{onClick:d,size:"sm",variant:"secondary",children:"查看被选中的行"}),e.jsx(te,{to:"/users/add",className:F("ml-2",Ae({variant:"default",size:"sm"})),children:"新增用户"})]})}),k.current&&e.jsx(at,{open:i,onOpenChange:w,title:e.jsxs("span",{children:["您确定要删除用户 ",e.jsx(N,{children:k.current.username})," 吗？"]}),onConfirm:Ee}),k.current&&e.jsx(_t,{open:v,onOpenChange:E,user:k.current,updateState:f})]})}function Yt(){st("用户管理");const[s]=G(),[n,t]=T.useState([]),{requestApi:x}=Z(),{data:r,error:b,loading:m,fetchData:d,discardFetch:f,updateState:l}=J(x),{toast:h}=ee(),i="/api/v1/users";Le(()=>{const c=Date.now();return E().then(),()=>f({url:i},c)});const w=Number(s.get(Q))||et,v=Number(s.get(X))||tt;async function E(){const c={pageNum:w,pageSize:v},p=s.get(z)||"createdAt",j=s.get(V)||"desc",u=s.get("username"),C=s.get("nickname"),R=s.get("status"),U=s.get("authority");return p&&(c.orderBy=p),j&&(c.order=j==="asc"?"asc":"desc"),u&&(c.username=u),C&&(c.nickname=C),R&&(c.status=R),U&&(c.authority=U),await d({url:i,urlParams:c})}function k(){const c=((r==null?void 0:r.list)||[]).filter((p,j)=>n.includes(j)).map(p=>p.id);if(c.length===0){h({title:"未选中任何行",description:"请先选中要操作的行",variant:"destructive"});return}h({title:"选中的行",description:e.jsxs("span",{children:["被选中的行 ID(s)：",e.jsx(N,{children:c.join(", ")})]})})}return e.jsxs(We,{className:"mx-auto h-full w-full",children:[e.jsxs(Ge,{children:[e.jsx(Qe,{children:"用户管理"}),e.jsx(Xe,{children:"可登录系统的所有账号信息"})]}),e.jsxs(Ze,{children:[e.jsx(ht,{loading:m}),e.jsx(Nt,{users:(r==null?void 0:r.list)||[],error:b,loading:m,pageNum:w,pageSize:v,total:(r==null?void 0:r.total)||0,onSelect:t,onShowSelection:k,updateState:l})]})]})}export{Yt as default};
